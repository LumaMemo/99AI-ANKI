# 用户消息渲染修复

## 目标

修复用户输入内容被错误渲染 Markdown 和 LaTeX 的问题。用户消息应该原样显示，不进行任何格式化渲染。

## 改动文件

`chat/src/views/chat/components/Message/Text/index.vue`

## 改动内容

### 1. 修改 `text` computed 属性

**修改前：**
```javascript
const text = computed(() => {
  const modifiedValue = normalizeMarkdownAndMath(props.content || '')
  return props.isUserMessage ? mdiUser.render(modifiedValue) : mdi.render(modifiedValue)
})
```

**修改后：**
```javascript
const text = computed(() => {
  // 用户消息不渲染 markdown/latex，直接显示原始文本（转义 HTML 防止 XSS）
  // 空格、tab、换行由 CSS white-space: pre-wrap 处理
  if (props.isUserMessage) {
    return (props.content || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;')
  }
  // AI 消息正常渲染 markdown + latex
  const modifiedValue = normalizeMarkdownAndMath(props.content || '')
  return mdi.render(modifiedValue)
})
```

### 2. 修改模板中用户消息的渲染样式

**修改前：**
```html
<div class="markdown-body text-[color:var(--text-primary)]" v-html="text"></div>
```

**修改后：**
```html
<div
  :class="['text-[color:var(--text-primary)]', { 'markdown-body': !isUserMessage }]"
  :style="isUserMessage ? 'white-space: pre-wrap; word-break: break-word;' : ''"
  v-html="text"
></div>
```

## 技术说明

- 用户消息只做 HTML 转义（防止 XSS），不渲染 Markdown/LaTeX
- 使用 CSS `white-space: pre-wrap` 保留空格、tab、换行
- 使用 `word-break: break-word` 确保长文本能正常换行
- AI 消息保持原有的 Markdown + LaTeX 渲染逻辑
- 复制功能不受影响，因为复制的是原始 `props.content`

## 测试方法

1. 发送包含 Markdown 语法的消息（如 `**粗体** _斜体_ # 标题`），确认显示为原始文本
2. 发送包含 LaTeX 的消息（如 `$x^2$ \frac{1}{2}`），确认显示为原始文本
3. 发送包含多个连续空格的消息，确认空格被保留
4. 发送包含 tab 缩进的消息，确认缩进被保留
5. 发送多行消息，确认换行被保留
6. 发送包含 HTML 标签的消息（如 `<script>alert(1)</script>`），确认被转义而非执行
7. 点击复制按钮，粘贴后确认内容与原始输入一致
8. 确认 AI 回复的 Markdown 和 LaTeX 仍然正常渲染
