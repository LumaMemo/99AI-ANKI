# 知识点卡片查看器开发路线图 (2025-12-27)

## 1. 当前状态调研

### 1.1 已完成内容
- **数据源**: `pdf_to_anki` 流程已能稳定生成 `anki_card_all` 目录结构并上传至腾讯云 COS。
- **后端基础**: `service` 模块已有成熟的 `KbService` 用于处理 COS 交互（签名、列表、上传下载）。
- **前端基础**: `chat` 项目已有 `KnowledgeBaseReadonly.vue` 等组件，具备基础的文件夹/文件展示逻辑。
- **渲染能力**: 项目中已集成基础的 Markdown 渲染逻辑。

### 1.2 可复用内容
- **COS 交互**: 复用 `KbService` 中的 `cos-nodejs-sdk-v5` 配置和签名逻辑。
- **API 封装**: 复用 `chat/src/utils/request` 进行后端通信。
- **状态管理**: 复用 `useChatStore` 存储当前选中的 PDF 信息。

### 1.3 需要添加/修改内容
- **后端**:
    - **新增**: `GET /kb/cards/tree`: 递归扫描指定 PDF 的 `anki_card_all` 前缀，返回层级树。
    - **新增**: `GET /kb/cards/detail`: 获取指定路径下 `base.json` 的解析内容。
- **前端**:
    - **新增**: `KnowledgeCard` 视图及路由。
    - **新增**: `KnowledgeTree` 侧边栏组件（支持动态深度）。
    - **新增**: `CardRenderer` 组件（支持递归解析 `content`、Markdown、KaTeX）。
    - **修改**: 在 PDF 列表或任务完成后增加“查看知识卡片”入口。

---

## 2. 开发步骤 (Incremental Steps)

### Step 1: 后端 - 目录树解析接口 (Done ✅)
- **目标**: 实现对 COS 中 `anki_card_all` 路径的递归扫描，并返回前端可用的树形结构。
- **修改代码**: 
    - `service/src/modules/kb/kb.service.ts`: 增加 `getCardTree` 方法。
    - `service/src/modules/kb/kb.controller.ts`: 增加对应路由。
- **验证脚本 (PowerShell)**: 
    ```powershell
    Invoke-RestMethod -Uri "http://localhost:49520/api/kb/cards/tree?pdfId=27" -Headers @{"Authorization"="Bearer <TOKEN>"}
    ```
- **测试结果**: 成功返回 `code: 200` 及层级化的 `data` 数组，包含 `base.json` 节点。
- **回滚策略**: 仅新增接口，不影响现有逻辑，直接删除新增代码即可。

### Step 2: 后端 - 知识点详情接口 (Done ✅)
- **目标**: 读取并返回 `base.json` 的 JSON 内容。
- **修改代码**: 
    - `service/src/modules/kb/kb.service.ts`: 增加 `getCardDetail` 方法。
    - `service/src/modules/kb/kb.controller.ts`: 增加对应路由。
- **验证脚本 (PowerShell - 处理 URL 编码)**: 
    ```powershell
    $path = "kb/2/root/.../base.json"
    $encodedPath = [uri]::EscapeDataString($path)
    Invoke-RestMethod -Uri "http://localhost:49520/api/kb/cards/detail?pdfId=27&path=$encodedPath" -Headers @{"Authorization"="Bearer <TOKEN>"}
    ```
- **测试结果**: 
    ```text
    code data
    ---- ----
     200 @{topic=基于改进樽海鞘群算法的医学图像多阈值分割方法 (US Patent); type=Fact; ...}
    ```
    确认已成功读取并解析 COS 中的 JSON 产物。

### Step 3: 前端 - 基础路由与布局 (Done ✅)
- **目标**: 建立 `/knowledge-card` 路由，实现左侧树+右侧主区域的响应式布局，并支持逻辑分发。
- **修改代码**: 
    - `chat/src/utils/router.ts`: 增加路由配置。
    - `chat/src/views/knowledgeCard/index.vue`: 初始布局实现，增加 **Topic Grid** 逻辑分发。
- **验证**: 访问 `/knowledge-card`，点击目录显示卡片网格，点击知识点显示详情占位。

### Step 4: 前端 - 智能目录树 (Windows 风格) (Done ✅)
- **目标**: 实现侧边栏树形组件，支持点击展开、选中高亮、实时搜索，并能识别 Topic 节点。
- **修改代码**: 
    - `chat/src/api/kb.ts`: 增加 `fetchKbCardTreeAPI` 和 `fetchKbCardDetailAPI`。
    - `chat/src/views/knowledgeCard/components/KnowledgeTree.vue`: 树形逻辑实现，增加 **实时搜索过滤**。
    - `chat/src/views/knowledgeCard/components/TreeItem.vue`: 递归子组件，增加 **Accent Bar** 视觉反馈。
    - `chat/src/views/knowledgeCard/index.vue`: 集成目录树并处理选中逻辑。
- **验证**: 搜索框输入关键词可实时过滤并自动展开，选中项左侧显示颜色条。

### Step 5: 前端 - 艺术大师卡片渲染器 (Done ✅)
- **目标**: 实现递归渲染逻辑，集成 Markdown 和 KaTeX，应用莫兰迪色系。
- **修改代码**: 
    - `chat/src/views/knowledgeCard/components/CardDetail.vue`
    - `chat/src/views/knowledgeCard/components/MarkdownRenderer.vue`
    - `chat/src/views/knowledgeCard/components/TopicGrid.vue`
- **验证**: 选中一个包含数学公式的 Topic，检查公式是否渲染正确，颜色是否符合范式。

### Step 6: 交互优化与移动端适配 (Done ✅)
- **目标**: 增加平滑过渡动效，实现移动端抽屉式导航。
- **修改代码**: 
    - `chat/src/views/knowledgeCard/index.vue` (集成 `NDrawer` 和 `Transition`)。
    - `chat/src/views/knowledgeCard/components/TopicGrid.vue` (增加 Hover 缩放与阴影)。
- **验证**: 切换浏览器至手机模式，测试滑动和点击体验，确认侧边栏可正常唤起与关闭。

### Step 7: 全局入口集成 (Done ✅)
- **目标**: 在知识库、笔记生成页和侧边栏建立多维入口，并解决“空状态”引导。
- **修改内容**:
    - **知识库**: 修改 `KnowledgeBaseReadonly.vue`，为 PDF 列表项添加“极光紫”标记及“查看卡片”图标按钮。
    - **笔记生成**: 修改 `NoteGenStatusCard.vue`，在生成结果区域增加“进入知识卡片模式”渐变按钮。
    - **侧边栏**: 修改 `List.vue`，在“笔记生成”入口下方新增“知识卡片库”入口。
    - **PDF 选择器**: 新增 `PdfSelector.vue`，当用户直接从侧边栏进入时，提供类似文件管理器的界面供用户选择知识库中的 PDF。
- **验证**: 从不同入口均能正确携带 `pdfId` 跳转，无 PDF 时显示引导选择界面。

### Step 8: 导航增强与返回逻辑 (Done ✅)
- **目标**: 建立完善的层级退回机制，增强面包屑导航，优化首屏加载体验。
- **修改内容**:
    - **全局返回**: 在顶部状态栏添加统一返回按钮，支持 `详情 -> 网格 -> 选择器 -> 退出` 的层级逻辑。
    - **面包屑增强**: 引入 `IconPark` 图标，支持点击面包屑节点快速跳转，并增加路径截断保护。
    - **自动网格加载**: 选择 PDF 后自动调用 `fetchKbCardTreeAPI` 加载根节点至网格，无需手动点击目录。
    - **沉浸式体验**: 选中叶子节点（卡片）时自动收起侧边栏（移动端）或聚焦内容区，增加加载动画。
- **验证**: 导航路径清晰，返回逻辑符合直觉，网格与详情切换平滑。

### Step 9: 全文搜索与高亮增强 (Done ✅)
- **目标**: 实现深度内容检索，并在进入卡片后自动高亮关键词。
- **修改内容**:
    - **后端**: 扩展 `KbService` 增加 `searchCards` 方法，支持对 `topic`、`content`、`uid` 的深度递归匹配，并生成内容摘要（Snippet）。
    - **前端搜索**: `KnowledgeTree.vue` 搜索框集成深度搜索逻辑，区分“目录匹配”与“内容匹配”展示。
    - **高亮渲染**: `MarkdownRenderer.vue` 增加正则匹配逻辑，使用莫兰迪黄 (`search-highlight`) 标记关键词。
    - **交互增强**: 搜索结果点击后自动携带 `keyword` 进入详情页，实现精准定位。
- **验证**: 搜索卡片内部文本，点击结果进入详情后，对应文本呈现高亮状态。

### Step 10: 结构化排序与页码增强 (Done ✅)
- **目标**: 还原 PDF 原始目录顺序，并在 UI 中展示各层级的页码信息，参考 `test_Step8` 的排序与格式化设计。
- **修改内容**:
    - **后端**:
        - 扩展 `getCardTree`，支持读取 `structure_toc_final.json` 或 `structure.json`。
        - 实现基于目录结构的递归排序逻辑，并处理 COS 路径的 URL 解码。
        - 增加“智能根节点识别”，自动对齐 COS 目录与 JSON 结构。
    - **前端**:
        - **目录树**: 在名称后方实时显示页码范围（如 `P10-15`），并支持显示原始标题。
        - **网格视图**: 遵循结构化排序，并在卡片下方增加页码标签。
- **验证**: 目录顺序与 PDF 原书完全一致，所有层级均可见清晰的页码标识。

---

## 3. 总结与后续建议
- **当前进度**: 核心功能已全部完成 (Step 1 - Step 10)。
- **后续优化**:
    - **导出功能**: 实现卡片导出为 Anki 包或 PDF。
    - **记忆算法**: 集成间隔重复算法，支持在查看器中直接进行复习。
    - **多模态支持**: 增加对图片和音频知识点的渲染支持。

---

## 4. 关键技术点
- **递归渲染**: 使用 Vue 递归组件处理 `content` 中的嵌套对象。
- **KaTeX 集成**: 确保 `$` 和 `$$` 的正确转义与渲染。
- **COS 性能**: 目录树接口需考虑缓存，避免频繁调用 COS API 导致延迟。

## 4. 回滚策略
- **代码层面**: 使用 Git 分支开发，失败时直接 `git checkout main`。
- **数据库层面**: 本次开发不涉及数据库 Schema 变更，风险极低。
- **接口层面**: 保持新旧接口并行，验证无误后再在前端切换调用。

---

## 5. 开发日志 (Development Log)

### 2025-12-27: Step 3 - 前端基础路由与布局 (Completed)
- **任务描述**: 建立 `/knowledge-card` 路由，实现沉浸式响应式布局。
- **关键变更**:
    - **路由**: 在 `router.ts` 注册子路由。
    - **布局适配**: 修改 `chat.vue`，在访问知识卡片时自动隐藏聊天侧边栏 `Sider`，并移除页面边距。
    - **逻辑修复**: 解决了 `chat.vue` 中针对 `isNoteGen` 的自动重定向干扰，确保路由能稳定停留在 `/knowledge-card`。
    - **UI 实现**: 创建 `knowledgeCard/index.vue`，实现桌面端侧边栏折叠与移动端抽屉交互。
- **自检**: 无新依赖，不影响旧数据，框架核心逻辑改动极小（仅布局开关）。
- **验证**: 访问 `http://localhost:49002/knowledge-card` 成功显示独立布局。

### 2025-12-27: Step 4 - 智能目录树与主区逻辑分发 (Completed)
- **任务描述**: 实现 Windows 风格目录树，支持搜索、高亮，并完成主区域的 Topic Grid 逻辑分发。
- **关键变更**:
    - **API**: 封装了 `fetchKbCardTreeAPI` 用于获取 COS 目录结构。
    - **目录树**: 
        - 实现递归组件 `TreeItem`。
        - 增加 `searchQuery` 实时过滤逻辑，搜索时自动展开匹配项。
        - 增加 `Accent Bar` (左侧颜色条) 强化选中视觉。
    - **主区域**: 
        - 实现逻辑分发：点击文件夹显示 `Topic Grid` (网格预览)，点击知识点显示 `Detail View`。
        - 增强面包屑：支持动态路径解析。
- **自检**: 修复了 `index.vue` 中的标签闭合错误，确保编译通过。
- **验证**: 搜索功能正常，目录与知识点图标区分明显，网格布局在不同屏幕下适配良好。

### 2025-12-27: Step 5 - 艺术大师卡片渲染器 (Completed)
- **任务描述**: 实现高度结构化的知识卡片渲染，支持 Markdown、LaTeX 和 6 大知识范式色系。
- **关键变更**:
    - **渲染引擎**: 
        - 集成 `markdown-it` 及其插件 `markdown-it-katex` 和 `highlight.js`。
        - 封装 `MarkdownRenderer.vue` 统一处理富文本。
    - **递归解析**: 
        - 在 `CardDetail.vue` 中实现 `RecursiveRenderer`。
        - 自动将 `Object` 映射为子标题，`Array` 映射为列表或带编号的 Item。
    - **视觉设计**: 
        - 应用莫兰迪色系（Concept/Fact/Rule/Procedure/Symbol/Case）。
        - 实现响应式卡片布局，包含 Header (范式标签、标题、元数据)、Body (递归内容) 和 Footer (UID、操作按钮)。
    - **导航增强**: 
        - 实现 `TopicGrid.vue`，在选中文件夹时展示子项网格，提升探索感。
- **自检**: 递归逻辑处理了深层嵌套，Markdown 样式已针对暗色模式适配。
- **验证**: 成功渲染包含复杂 LaTeX 公式和多层级 JSON 结构的知识点。

### 2025-12-27: Step 6 - 交互优化与移动端适配 (Completed)
- **任务描述**: 提升整体交互流畅度，确保移动端可用性。
- **关键变更**:
    - **移动端适配**: 
        - 集成 `naive-ui` 的 `NDrawer` 组件，在移动端点击菜单按钮时弹出侧边栏。
        - 优化面包屑显示，在小屏幕下自动截断长路径。
    - **动效增强**: 
        - 使用 Vue `<Transition>` 实现主区域内容切换的淡入淡出效果。
        - 在 `TopicGrid` 中增加 `animate-in` 动画，使网格项依次浮现。
        - 强化 Hover 态：网格项在悬停时会有轻微缩放和阴影加深。
- **自检**: 移动端点击知识点后会自动收起侧边栏，体验顺滑。
- **验证**: 在 Chrome DevTools 模拟不同机型，布局均能完美适配。

### 2025-12-27: Step 7 - 全局入口集成 (Completed)
- **任务描述**: 在知识库、笔记生成页和侧边栏建立多维入口，并解决“空状态”引导。
- **关键变更**:
    - **多维入口**:
        - **知识库**: 在 `KnowledgeBaseReadonly.vue` 中为 PDF 列表项添加“查看卡片”图标按钮。
        - **笔记生成**: 在 `NoteGenStatusCard.vue` 中为已完成任务添加“进入知识卡片模式”紫色渐变按钮。
        - **侧边栏**: 在 `List.vue` 的“笔记生成”下方新增“知识卡片库”入口。
    - **空状态处理**:
        - 实现 `PdfSelector.vue` 组件，支持在查看器内直接浏览并选择知识库中的 PDF。
        - 优化 `index.vue` 逻辑，当无 `pdfId` 时自动展示选择器，而非显示空白页。
- **自检**: 确保了所有入口跳转时都能正确传递 `pdfId` 参数。
- **验证**: 从侧边栏进入可看到文件选择器，从具体文件进入可直接看到内容。

### 2025-12-27: Step 8 - 导航增强与返回逻辑 (Completed)
- **任务描述**: 建立完善的层级退回机制，增强面包屑导航，优化首屏加载体验。
- **关键变更**:
    - **层级导航**:
        - 在顶部 Header 添加全局返回按钮，逻辑：`详情 -> 网格 -> 选择器 -> 退出`。
        - 增强面包屑：引入 `IconPark` 图标，支持点击面包屑节点快速跳转。
    - **加载优化**:
        - 实现 `rootNodes` 自动加载逻辑，选择 PDF 后自动展示根目录网格。
        - 增加 `loading` 状态反馈和 `animate-in` 进场动画。
    - **路由同步**:
        - 增加对 `route.query.pdfId` 的监听，支持通过 URL 直接定位文件。
- **自检**: 修复了面包屑在长标题下的溢出问题。
- **验证**: 导航路径清晰，返回逻辑符合直觉，网格与详情切换平滑。

### 2025-12-27: Step 9 - 全文搜索与高亮增强 (Completed)
- **任务描述**: 实现深度内容检索，并在进入卡片后自动高亮关键词。
- **关键变更**:
    - **后端搜索**:
        - 在 `KbService` 中实现 `searchCards`，支持对 `base.json` 的 `topic`、`content`、`uid` 进行深度递归匹配。
        - 增加 `searchInObject` 助手，自动提取包含关键词的内容摘要（Snippet）。
    - **前端搜索 UI**:
        - 更新 `KnowledgeTree.vue`，在搜索时同时展示“目录匹配”和“内容匹配”结果。
        - 集成 `useDebounceFn` 优化搜索性能，减少 API 调用。
    - **高亮渲染**:
        - 更新 `MarkdownRenderer.vue`，使用正则匹配在 HTML 渲染后注入 `<span class="search-highlight">`。
        - 应用莫兰迪黄视觉风格，确保高亮在暗色模式下依然清晰。
- **自检**: 搜索逻辑不影响现有目录树过滤，高亮逻辑避开了 HTML 标签内部属性。
- **验证**: 搜索“算法”等关键词，可精准定位到卡片内部文本并高亮显示。

