# 知识点卡片查看器开发路线图 (2025-12-27)

## 1. 当前状态调研

### 1.1 已完成内容
- **数据源**: `pdf_to_anki` 流程已能稳定生成 `anki_card_all` 目录结构并上传至腾讯云 COS。
- **后端基础**: `service` 模块已有成熟的 `KbService` 用于处理 COS 交互（签名、列表、上传下载）。
- **前端基础**: `chat` 项目已有 `KnowledgeBaseReadonly.vue` 等组件，具备基础的文件夹/文件展示逻辑。
- **渲染能力**: 项目中已集成基础的 Markdown 渲染逻辑。

### 1.2 可复用内容
- **COS 交互**: 复用 `KbService` 中的 `cos-nodejs-sdk-v5` 配置和签名逻辑。
- **API 封装**: 复用 `chat/src/utils/request` 进行后端通信。
- **状态管理**: 复用 `useChatStore` 存储当前选中的 PDF 信息。

### 1.3 需要添加/修改内容
- **后端**:
    - **新增**: `GET /kb/cards/tree`: 递归扫描指定 PDF 的 `anki_card_all` 前缀，返回层级树。
    - **新增**: `GET /kb/cards/detail`: 获取指定路径下 `base.json` 的解析内容。
- **前端**:
    - **新增**: `KnowledgeCard` 视图及路由。
    - **新增**: `KnowledgeTree` 侧边栏组件（支持动态深度）。
    - **新增**: `CardRenderer` 组件（支持递归解析 `content`、Markdown、KaTeX）。
    - **修改**: 在 PDF 列表或任务完成后增加“查看知识卡片”入口。

---

## 2. 开发步骤 (Incremental Steps)

### Step 1: 后端 - 目录树解析接口 (Done ✅)
- **目标**: 实现对 COS 中 `anki_card_all` 路径的递归扫描，并返回前端可用的树形结构。
- **修改代码**: 
    - `service/src/modules/kb/kb.service.ts`: 增加 `getCardTree` 方法。
    - `service/src/modules/kb/kb.controller.ts`: 增加对应路由。
- **验证脚本 (PowerShell)**: 
    ```powershell
    Invoke-RestMethod -Uri "http://localhost:49520/api/kb/cards/tree?pdfId=27" -Headers @{"Authorization"="Bearer <TOKEN>"}
    ```
- **测试结果**: 成功返回 `code: 200` 及层级化的 `data` 数组，包含 `base.json` 节点。
- **回滚策略**: 仅新增接口，不影响现有逻辑，直接删除新增代码即可。

### Step 2: 后端 - 知识点详情接口 (Done ✅)
- **目标**: 读取并返回 `base.json` 的 JSON 内容。
- **修改代码**: 
    - `service/src/modules/kb/kb.service.ts`: 增加 `getCardDetail` 方法。
    - `service/src/modules/kb/kb.controller.ts`: 增加对应路由。
- **验证脚本 (PowerShell - 处理 URL 编码)**: 
    ```powershell
    $path = "kb/2/root/.../base.json"
    $encodedPath = [uri]::EscapeDataString($path)
    Invoke-RestMethod -Uri "http://localhost:49520/api/kb/cards/detail?pdfId=27&path=$encodedPath" -Headers @{"Authorization"="Bearer <TOKEN>"}
    ```
- **测试结果**: 
    ```text
    code data
    ---- ----
     200 @{topic=基于改进樽海鞘群算法的医学图像多阈值分割方法 (US Patent); type=Fact; ...}
    ```
    确认已成功读取并解析 COS 中的 JSON 产物。

### Step 3: 前端 - 基础路由与布局 (Done ✅)
- **目标**: 建立 `/knowledge-card` 路由，实现左侧树+右侧主区域的响应式布局。
- **修改代码**: 
    - `chat/src/utils/router.ts`: 增加路由配置。
    - `chat/src/views/knowledgeCard/index.vue`: 初始布局实现。
- **验证脚本**: 浏览器访问 `http://localhost:49002/knowledge-card` 查看页面是否渲染。

### Step 4: 前端 - 智能目录树 (Windows 风格) (In Progress ⏳)
- **目标**: 实现侧边栏树形组件，支持点击展开、选中高亮，并能识别 Topic 节点。
- **修改代码**: 
    - `chat/src/views/knowledgeCard/components/KnowledgeTree.vue`
- **验证脚本**: 点击目录树，观察控制台是否正确输出选中的路径。

### Step 5: 前端 - 艺术大师卡片渲染器
- **目标**: 实现递归渲染逻辑，集成 Markdown 和 KaTeX，应用莫兰迪色系。
- **修改代码**: 
    - `chat/src/views/knowledgeCard/components/CardDetail.vue`
    - `chat/src/views/knowledgeCard/components/MarkdownRenderer.vue`
- **验证脚本**: 选中一个包含数学公式的 Topic，检查公式是否渲染正确，颜色是否符合范式。

### Step 6: 交互优化与移动端适配
- **目标**: 增加平滑过渡动效，实现移动端抽屉式导航。
- **修改代码**: 
    - `chat/src/views/knowledgeCard/index.vue` (CSS 动效与 Media Query)。
- **验证脚本**: 切换浏览器至手机模式，测试滑动和点击体验。

---

## 3. 关键技术点
- **递归渲染**: 使用 Vue 递归组件处理 `content` 中的嵌套对象。
- **KaTeX 集成**: 确保 `$` 和 `$$` 的正确转义与渲染。
- **COS 性能**: 目录树接口需考虑缓存，避免频繁调用 COS API 导致延迟。

## 4. 回滚策略
- **代码层面**: 使用 Git 分支开发，失败时直接 `git checkout main`。
- **数据库层面**: 本次开发不涉及数据库 Schema 变更，风险极低。
- **接口层面**: 保持新旧接口并行，验证无误后再在前端切换调用。

---

## 5. 开发日志 (Development Log)

### 2025-12-27: Step 3 - 前端基础路由与布局 (Completed)
- **任务描述**: 建立 `/knowledge-card` 路由，实现沉浸式响应式布局。
- **关键变更**:
    - **路由**: 在 `router.ts` 注册子路由。
    - **布局适配**: 修改 `chat.vue`，在访问知识卡片时自动隐藏聊天侧边栏 `Sider`，并移除页面边距。
    - **逻辑修复**: 解决了 `chat.vue` 中针对 `isNoteGen` 的自动重定向干扰，确保路由能稳定停留在 `/knowledge-card`。
    - **UI 实现**: 创建 `knowledgeCard/index.vue`，实现桌面端侧边栏折叠与移动端抽屉交互。
- **自检**: 无新依赖，不影响旧数据，框架核心逻辑改动极小（仅布局开关）。
- **验证**: 访问 `http://localhost:49002/knowledge-card` 成功显示独立布局。

