# 用户自定义头像功能分析与设计方案

## 1. 现状分析
当前 "99AI-ANKI" 项目中，后端服务 (`service`) 和数据库 (`users` 表) 已经支持存储和更新用户头像，管理端 (`admin`) 也有相关的图片上传和设置功能。然而，用户端 (`chat`) 的个人设置页面虽然展示了用户头像，但缺失了上传或修改头像的交互入口和逻辑。

## 2. 涉及代码文件

### 2.1 用户端 (Frontend - Chat)
用户端显示头像但无法修改。
- **文件路径**: `99AI-ANKI/chat/src/components/Settings/AccountManagement.vue`
- **相关代码**:
  ```vue
  <!-- 头像展示区域，目前仅用于展示 -->
  <div class="flex items-center">
    <div class="w-20 text-[color:var(--text-tertiary)]">头像</div>
    <div class="avatar avatar-lg avatar-bordered avatar-primary">
      <img v-if="avatar" :src="avatar" class="w-full h-full object-cover" alt="用户头像" />
      <User v-if="!avatar" theme="outline" size="20" class="text-white" aria-hidden="true" />
    </div>
  </div>
  ```
- **API 定义**: `99AI-ANKI/chat/src/api/index.ts` (包含 `fetchUpdateInfoAPI` 和 `fetchGetInfo`)
- **状态管理**: `99AI-ANKI/chat/src/store/modules/auth/index.ts` (包含 `userInfo` 和 `getUserInfo`)

### 2.2 后端服务 (Backend - Service)
后端已经具备更新用户信息和上传文件的能力。
- **用户实体**: `99AI-ANKI/service/src/modules/user/user.entity.ts`
  ```typescript
  @Column({
    length: 300,
    nullable: true,
    default: '',
    comment: '用户头像',
  })
  avatar: string;
  ```
- **更新接口**: `99AI-ANKI/service/src/modules/user/user.controller.ts`
  ```typescript
  @Post('update')
  @ApiOperation({ summary: '更新用户信息' })
  @UseGuards(JwtAuthGuard)
  @ApiBearerAuth()
  async update(@Body() body: UpdateUserDto, @Req() req: Request) {
    return await this.userService.updateInfo(body, req);
  }
  ```
- **上传接口**: `99AI-ANKI/service/src/modules/upload/upload.controller.ts` (已存在 `/upload/file` 接口)

### 2.3 管理端 (Admin)
管理端作为参考，已经实现了图片上传组件。
- **参考实现**: `99AI-ANKI/admin/src/views/personal/setting.vue` (使用了 `image-upload` 组件)

## 3. 设计方案

### 3.1 数据库方案
**结论：不需要新建数据库表或字段。**
- `users` 表中已经存在 `avatar` 字段 (varchar 300)，足以存储头像的 URL。

### 3.2 后端方案
**结论：基本不需要修改后端代码。**
- 现有的 `/user/update` 接口支持更新 `avatar` 字段。
- 现有的 `/upload/file` 接口支持文件上传。
- 唯一需要注意的是，确保 `/upload/file` 接口对于普通用户的上传频率限制（Rate Limiting）和文件大小/类型限制配置得当，以防止滥用。

### 3.3 前端方案 (Chat)
主要工作量在前端 `AccountManagement.vue` 组件的改造。

**交互流程：**
1.  **UI 改造**：在头像区域添加一个“修改”按钮，或者将头像区域变为可点击，并显示“更换头像”的提示（如悬停遮罩）。
2.  **文件选择**：添加一个隐藏的 `<input type="file" accept="image/*" />`。点击修改按钮时触发该 Input 的点击事件。
3.  **上传处理**：
    -   监听 Input 的 `change` 事件。
    -   校验文件类型（图片）和大小（如 < 2MB）。
    -   调用 `uploadFile` API 将图片上传至服务器（或 OSS）。
4.  **更新资料**：
    -   获取上传成功后的 URL。
    -   调用 `fetchUpdateInfoAPI`，传入 `{ avatar: newAvatarUrl }`。
5.  **状态同步**：
    -   更新成功后，调用 `authStore.getUserInfo()` 刷新全局用户信息，确保页面头像即时更新。
    -   提示用户“修改成功”。

### 3.4 方案优劣对比

| 方案 | 描述 | 优点 | 缺点 |
| :--- | :--- | :--- | :--- |
| **方案 A: 自定义上传 (推荐)** | 用户上传图片 -> 存入服务器/OSS -> 更新 Profile | 高度自定义，用户体验好，利用现有架构。 | 需要存储空间，需处理图片审核(若有合规要求)。 |
| **方案 B: 预设头像库** | 系统提供一组头像供用户选择 | 实现简单，无审核风险，节省存储。 | 个性化程度低，无法满足用户展示自我的需求。 |
| **方案 C: 第三方头像 (Gravatar)** | 根据邮箱生成 Gravatar 或 DiceBear 头像 | 无需存储，全自动。 | 依赖第三方服务，国内访问可能不稳定。 |

**建议采用方案 A**，因为项目已经具备完善的上传服务 (`UploadModule`) 和存储配置 (Local/COS/OSS/S3)，且用户实体已支持头像 URL 存储，这是最符合当前架构且体验最好的方案。
