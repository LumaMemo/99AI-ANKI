# 99AI-ANKI 知识库 PDF（腾讯云 COS 私有）功能设计方案

日期：2025-12-17

> 本设计方案面向「99AI-ANKI」现有架构（chat 前端 / service 后端 NestJS / admin 管理端），新增一套与当前“普通文件上传”分离的“知识库 PDF”能力：
> - **上传到腾讯云 COS**（私有读写）
> - **后端落库记录**用户 PDF、文件夹、用量
> - **chat 端固定常置顶知识库栏**：文件夹管理、PDF 列表、重命名、删除、上传、空间用量展示
> - **admin 端套餐扩展**：为不同套餐配置“知识库空间大小”

---

## 1. 背景与目标

### 1.1 现状（已存在能力）
- 现有上传：`POST /api/upload/file`，根据后台配置选择本地/S3/COS/OSS/Chevereto，主要用于“聊天附件/图片”。
- 现有上传返回的是可访问 URL（偏向公网直链）。
- 现有套餐体系：`crami_package`（套餐） + `user_balances.packageId`（用户当前套餐）。

### 1.2 本次目标（必须实现）
1) **新增知识库 PDF 上传链路（与现有 upload 分开）**
- 新接口、独立的存储配置（至少 bucket/region/secret/prefix 可独立配置）。
- 上传对象固定为 PDF（可扩展但本期先锁 PDF）。

2) **COS 私有存储：私有存、私有取**
- COS Bucket 为私有；用户不拿到永久直链。
- 下载/预览通过后端签名 URL（短期有效）或后端转发流式下载。

3) **后端落库：记录用户 PDF 与目录结构**
- 能查询列表、文件夹树。
- 文件元信息包含：原始名、展示名、大小、COS key、bucket/region、创建时间。

4) **chat 前端：常置顶知识库栏**
- 显示：文件夹树 + PDF 列表。
- 操作：新建文件夹、上传 PDF、删除、重命名。
- 显示配额：总空间/已用/剩余。

5) **admin：套餐可配置知识库空间**
- 在现有套餐管理页给套餐增加“知识库空间配额”。

### 1.3 非目标（本期不做/先不强依赖）
- 不在本期强制实现：PDF 解析、向量化、RAG 召回、与对话自动关联。
- 不做跨用户共享（知识库仅私有）。

---

## 2. 术语与约定

- **KB**：Knowledge Base（知识库）。
- **KB 文件夹**：用户自定义目录树。
- **KB PDF**：用户上传的 PDF 条目（数据库记录 + COS 对象）。
- **配额（quota）**：用户知识库可用总空间（字节）。
- **用量（used）**：用户已占用空间（字节）。

---

## 3. 存储设计（COS 私有）

### 3.1 COS Key 规则（满足“用户目录\文件夹\pdf名称\pdf文件”）

要求：
- 逻辑路径可读：包含 userId、文件夹路径、pdf 名称作为目录。
- 支持同名文件：避免 key 冲突。
- 支持重命名：尽量只改“展示名”，避免 COS 侧 copy/delete。

推荐 Key 结构（生产安全且满足要求）：

- `kb/{userId}/{folderPath}/{pdfDisplaySlug}/{fileId}/{originalFileName}.pdf`

说明：
- `folderPath` 为“用户自定义文件夹链路”拼接（URL-safe / 去非法字符），例如：`work/ai`。
- `pdfDisplaySlug` 为展示名 slug（用于可读性）。
- `fileId` 使用数据库主键或 UUID（保证唯一，避免重名冲突）。
- `originalFileName` 保留原始文件名（便于下载时友好）。

示例：
- `kb/10086/work/ai/深度学习导论/923481/深度学习导论.pdf`

> 备注：如果你坚持“最后一级文件名必须等于展示名.pdf”，也可以做，但建议依旧保留 `fileId` 级目录，避免展示名重名导致覆盖。

### 3.2 私有读取策略

两种实现（二选一，推荐 A）：

A. **后端签名 URL（推荐）**
- 后端保存 COS Secret（仅服务端持有）。
- 客户端需要预览/下载时：调用后端接口获取**短期有效**的签名 URL（例如 60 秒）。
- 客户端使用该 URL 拉取 PDF（浏览器预览/下载）。

B. **后端转发下载（更安全但更耗带宽）**
- 客户端请求后端 `/api/kb/files/:id/stream`。
- 后端从 COS 拉取对象流并 pipe 给客户端。

### 3.3 ACL 与权限
- Bucket 私有。
- 对象默认 private。
- 所有读写操作必须校验 `file.userId === req.user.id`。

---

## 4. 数据库设计（新增表）

> 目标：既能表达文件夹树，又能快速统计用量；并且不依赖“聊天对话组 fileUrl 字段”。

### 4.1 `kb_folder`（知识库文件夹）

建议字段：
- `id` bigint PK
- `userId` bigint（owner）
- `parentId` bigint nullable（根目录为 null/0）
- `name` varchar(255)
- `path` varchar(1024)
  - 规范化的逻辑路径（例如：`/work/ai`），便于快速查询
- `sortOrder` int default 0
- `createdAt/updatedAt/deletedAt`

约束：
- 同一 `userId + parentId + name` 唯一（防止同级重名）。

### 4.2 `kb_pdf`（知识库 PDF 记录表）

建议字段：
- `id` bigint PK
- `userId` bigint
- `folderId` bigint（FK -> kb_folder.id，根目录可为 null/0）
- `displayName` varchar(255)（可重命名）
- `originalName` varchar(255)
- `ext` varchar(16)（固定 `pdf`）
- `mimeType` varchar(64)（`application/pdf`）
- `sizeBytes` bigint
- `cosBucket` varchar(128)
- `cosRegion` varchar(64)
- `cosKey` varchar(1024)
- `etag` varchar(128) nullable（COS 返回的 ETag，可选）
- `status` tinyint（1=active, 2=deleting, 3=deleted）
- `createdAt/updatedAt/deletedAt`

索引建议：
- `(userId, folderId, createdAt)`
- `(userId, status)`

### 4.3 `kb_user_usage`（用户知识库用量缓存，可选但推荐）

建议字段：
- `userId` bigint PK
- `usedBytes` bigint default 0
- `updatedAt`

说明：
- 上传成功/删除成功时增减 `usedBytes`。
- 查询配额时：
  - `quotaBytes` 从“套餐”计算
  - `usedBytes` 读缓存（避免每次 sum 全表）

---

## 5. 配额与套餐（admin 可配置）

### 5.1 方案选择

推荐复用现有套餐体系（最小改动，符合你“不同套餐设置空间大小”）：
- 扩展 `crami_package` 增加字段：`kbQuotaBytes`（或 `kbQuotaMB`）
- 用户当前套餐来自 `user_balances.packageId`，因此用户知识库配额来自对应套餐。

> 如果未来要支持“单独购买知识库空间包”，可再加独立的 KB 套餐表，但本期不建议。

### 5.2 配额计算规则

- `quotaBytes`：读取当前用户套餐 `crami_package.kbQuotaBytes`
  - 没有套餐/为空时：默认为 0（不允许上传）或给一个免费额度（由你决定）
- `usedBytes`：来自 `kb_user_usage.usedBytes`（或 sum kb_pdf.sizeBytes where active）
- `remainingBytes = max(quotaBytes - usedBytes, 0)`

### 5.3 上传时的配额校验

- 上传前（后端）：
  - 校验 MIME/扩展名为 PDF
  - 校验 `sizeBytes <= remainingBytes`
  - 校验 `sizeBytes <= 单文件上限`（建议配置项，比如 50MB；与现有 10MB 无关）

---

## 6. 后端设计（NestJS service）

### 6.1 模块划分

新增模块：`knowledgeBase`（或 `kb`）
- `kb-folder`：文件夹 CRUD
- `kb-file`：PDF 上传/列表/重命名/删除/签名 URL
- `kb-quota`：配额查询（聚合接口）

与现有 `UploadModule` 的关系：
- **不复用** `POST /api/upload/file`，避免影响现有附件链路。
- 可以复用“COS SDK 初始化/全局配置读取”的工具函数，但建议新增 KB 专属配置 key。

### 6.2 配置来源（沿用 config 表）

沿用 `config` 表（GlobalConfigService），新增以下 key（建议）：
- `kbTencentCosStatus`（0/1）
- `kbCosSecretId`
- `kbCosSecretKey`
- `kbCosBucket`
- `kbCosRegion`
- `kbCosPrefix`（默认 `kb/`）
- `kbCosSignedUrlExpiresSeconds`（默认 60）
- `kbSinglePdfMaxBytes`（默认例如 50MB）

> 这样不会与现有“图片/附件上传”的 COS 配置互相干扰。

### 6.3 API 设计（给 chat 使用）

统一前缀：`/api/kb`
鉴权：`JwtAuthGuard`

#### 6.3.1 配额信息
- `GET /api/kb/quota`
  - 响应：`{ quotaBytes, usedBytes, remainingBytes }`

#### 6.3.2 文件夹
- `GET /api/kb/folders/tree`
  - 响应：树形结构（只返回当前用户）
- `POST /api/kb/folders`
  - 入参：`{ parentId?, name }`
- `PATCH /api/kb/folders/:id`
  - 入参：`{ name }`
- `DELETE /api/kb/folders/:id`
  - 行为：
    - 若文件夹非空：建议禁止删除并提示先清空；或支持递归删除（需确认产品规则）

#### 6.3.3 PDF 文件
- `GET /api/kb/files?folderId=...&page=...&size=...`
  - 响应：`{ rows, count }`，每项包含 `id, displayName, sizeBytes, createdAt, folderId` 等

- `POST /api/kb/files/upload?folderId=...`
  - multipart form-data：`file`（PDF）
  - 行为：
    1) 校验配额与 PDF
    2) 写入 DB（先创建记录拿到 id，或先生成 UUID）
    3) putObject 到 COS
    4) 更新 DB 写入 cosKey、etag、status=active
    5) 更新 `kb_user_usage.usedBytes += size`

- `PATCH /api/kb/files/:id`
  - 入参：`{ displayName }`（重命名）
  - 说明：仅改“展示名”，不改 cosKey（避免 copy/delete）

- `DELETE /api/kb/files/:id`
  - 行为：
    1) 标记 status=deleting
    2) 删除 COS 对象
    3) 标记 deleted，并 `kb_user_usage.usedBytes -= size`

- `GET /api/kb/files/:id/signed-url`
  - 响应：`{ url, expiresAt }`
  - 说明：用于前端预览/下载

> 可选增强：如果担心签名 URL 被分享，仍然有“短期有效”风险可接受；若要求更严格则改为后端转发流。

### 6.4 并发与一致性

- 上传：建议使用事务（DB）+ 幂等策略（例如同一个上传请求携带 clientUploadId），避免重复扣用量。
- 删除：先 DB 标记，再删 COS；若 COS 删除失败可重试（定时任务修复）。

---

## 7. Chat 前端设计（固定知识库栏）

### 7.1 入口与布局

- 在 chat 页面左侧/顶部（取决于现有布局）新增“知识库”常置顶区域。
- 内容：
  - 顶部：配额条（总/已用/剩余）
  - 中部：文件夹树
  - 右侧或下方：当前文件夹的 PDF 列表

### 7.2 交互需求

- 新建文件夹：选择父目录 -> 输入名称 -> 创建
- 上传 PDF：
  - 选择目标文件夹（当前选中为默认）
  - 选择 PDF 后立即上传
  - 上传进度（可选）
  - 成功后列表刷新 + 配额刷新
- 重命名：
  - 文件夹重命名
  - PDF 展示名重命名
- 删除：
  - PDF 删除（确认）
  - 文件夹删除（按后端规则：空文件夹可删；非空提示）

### 7.3 与聊天的关系（本期建议）

为了保证“分开但可用”，建议本期先做到：
- 知识库栏管理 PDF
- 后续在“发送消息”时支持选择知识库 PDF 作为上下文（RAG 之前可以先做到“选中文档列表传给后端”，后端暂不解析也不阻塞）

---

## 8. Admin 管理端设计（套餐增加知识库空间）

### 8.1 数据字段

在 `crami_package` 增加：
- `kbQuotaBytes`（bigint）或 `kbQuotaMB`（int）

推荐 `kbQuotaBytes`，前端展示时换算。

### 8.2 管理端 UI 改动点

在“套餐管理”新增一个表单项：
- 知识库空间（MB/GB）

并在列表里展示该字段。

### 8.3 生效方式

- 用户配额根据 `user_balances.packageId` 对应套餐实时生效。
- 若用户更换套餐：
  - `quotaBytes` 变化
  - `usedBytes` 不变
  - 如果 `usedBytes > quotaBytes`：禁止继续上传，提示空间不足（不自动删文件）。

---

## 9. 安全与风控

- 权限：所有 KB 资源都必须校验 owner。
- 防滥用：
  - 单文件大小上限（KB 专属）
  - 用户上传频率限制（可复用现有 Redis 频控实现，但 key 独立：`kb:upload:freq:{userId}:{hour}`）
- 文件类型：仅允许 PDF（扩展名 + MIME + 可选 magic header 校验 `%PDF-`）。

---

## 10. 迁移与落地步骤（建议按顺序做）

1) 后端：新增实体与表（kb_folder、kb_pdf、kb_user_usage）
2) 后端：新增 KB 模块与接口（folders/files/quota）
3) 后端：接入 COS 私有签名 URL（或转发下载）
4) admin：扩展套餐字段并可编辑
5) chat：知识库栏 UI + 调用 KB 接口
6) 联调：上传/删除/重命名/配额显示

---

## 11. 需要你最终拍板的 3 个产品/实现选择（否则我按默认实现）

1) 文件夹删除规则，A：
- A: 仅允许删除空文件夹（默认）
- B: 允许递归删除（需要更强的确认与后台异步）

2) 私有读取方式,A：
- A: 返回签名 URL（默认）
- B: 后端流式转发（更安全但更耗资源）

1) 免费用户默认配额,B,50MB：
- B: 给一个很小的免费额度（例如 50MB/100MB）

---

## 12. 附：与现有模块对齐的实现提示

- COS SDK：现有上传模块已使用 `cos-nodejs-sdk-v5`，KB 模块可复用同 SDK。
- 配置读取：沿用 GlobalConfigService 的 config 表存储方式。
- 套餐系统：沿用 `crami_package` + `user_balances.packageId`。

