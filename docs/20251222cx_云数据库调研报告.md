# 99AI-ANKI 云数据库调研报告（MySQL + Redis）

日期：2025-12-22

## 1. 结论先行（可直接照抄执行）

- **MySQL：**
  - **1核2G**：仅建议用于「个人/小流量」或“刚上线验证期”。如果启用较多写入（聊天记录、日志、统计、知识库记录等）或并发上来，容易在高峰出现 CPU 抖动、慢查询堆积。
  - **2核4G**：建议作为「小型生产」起步规格，更稳；在没有明确容量数据时，这是更保守、更省心的默认选择。
- **Redis：建议需要（当前代码属于硬依赖）**
  - 项目后端 `service` 在启动阶段会连接 Redis 并读写 `JWT_SECRET`；并且登录 token、验证码、限流、上传计数等功能都通过 Redis 存储。
  - 结论：**不配 Redis 会导致启动失败或核心功能异常**，除非你改代码把这些状态迁移到 MySQL/本地配置。

## 2. 项目现状（为什么会需要 MySQL + Redis）

基于仓库当前实现（位于 `99AI-ANKI/service`）：

- **MySQL（TypeORM）**
  - 依赖：`@nestjs/typeorm` + `typeorm` + `mysql2`
  - 连接参数来自 `.env`：`DB_HOST/DB_PORT/DB_USER/DB_PASS/DB_DATABASE`
  - 字符集：`utf8mb4`，时区：`+08:00`
- **Redis（硬依赖）**
  - 启动时使用 `ioredis`：生成/读取 `JWT_SECRET`（用于 JWT 签名）
  - 全局缓存模块 `RedisCacheModule` 使用 `redis` 官方客户端（node-redis）
  - Redis 典型用途：
    - `JWT_SECRET` 保存
    - 登录 token（限制多设备登录）
    - 验证码
    - 限流（请求窗口计数）
    - 上传次数计数

> 提示：当前实现里 Redis 既用于「安全敏感状态」（JWT Secret、token）又用于「业务缓存/计数」。因此更推荐使用**云 Redis（托管）**而不是自己在业务机上跑。

## 3. 规格是否够用：1核2G vs 2核4G（MySQL）

下面是“没做压测前”的保守评估方法：

### 3.1 影响 MySQL 资源的主要因素

- **数据增长**：聊天记录（ChatLog）、统计、订单/用户、知识库关联等表会持续增长。
- **写入比例**：聊天对话、日志写入在高峰期会放大 IO 与锁等待。
- **并发连接数**：Node 服务如果连接池偏大、并发请求多，会把 MySQL 顶到 `max_connections` 或产生上下文切换。
- **慢查询**：未命中索引/模糊查询/统计聚合会持续吃 CPU。

### 3.2 经验型建议（适合“先上云再优化”）

- **1核2G MySQL 够用的前提（偏苛刻）**
  - 业务规模较小、并发低
  - 写入不密集（聊天记录量不大）
  - 表规模在早期（数据量小）
  - 能接受偶发慢/抖动

- **2核4G MySQL 更推荐作为起步生产**
  - 更能扛住高峰时的 CPU/IO 抖动
  - InnoDB buffer pool 可配得更合理（缓存更多索引/热数据）
  - 给后续增长留余量，减少频繁升配/迁移

### 3.3 我的推荐（在你没提供DAU/并发/数据量前）

- 如果你现在目标是“可稳定对外使用”：**直接 2核4G 起步**。
- 如果只是“跑通流程/小范围自用/内部测试”：**1核2G 可作为临时规格**，但要预留随时升配。

## 4. 是否需要 Redis 云数据库？（结论：需要）

### 4.1 为什么说是“必须”

- 服务启动阶段会连接 Redis 并读写 `JWT_SECRET`。
- 登录态（token）校验、验证码、限流、上传计数等都依赖 Redis。

因此：
- **生产建议：使用云 Redis（托管，带高可用/备份/监控）**
- 如果你不想上 Redis：只能走“改代码/改架构”路线，把 JWT secret 固定到环境变量、把 token/验证码/限流落库或用其他服务。

### 4.2 Redis 规格建议

- 起步建议：**1GB 内存级别**（具体 SKU 随云厂商差异）
- 如果只做验证码/限流/少量 token：容量压力不大，更多是稳定性与网络延迟
- 如果未来做大量缓存（例如聊天结果缓存/流式缓存）：再考虑 2GB/4GB

## 5. 推荐软件版本与关键配置

### 5.1 MySQL

- **推荐版本：MySQL 8.0.x（云厂商提供的 8.0）**
- 字符集：`utf8mb4`
- 排序规则：`utf8mb4_unicode_ci`（与当前 compose 一致）
- 时区：`Asia/Shanghai`（或保持应用侧 `+08:00`）
- 存储引擎：InnoDB

**关键参数建议（能改则改，RDS 受限则跳过）：**

- `innodb_buffer_pool_size`：建议占可用内存的 60%~70%
  - 2GB 机器：约 1.2GB
  - 4GB 机器：约 2.5GB
- `max_connections`：建议 200 起步（更高要结合连接池与内存）
- 打开慢查询日志：便于定位索引问题

> 注意：你当前 `docker-compose.yml` 使用 `mysql:8` 并开启了 `--mysql-native-password=ON`。
> 云 MySQL 8 默认认证插件可能是 `caching_sha2_password`；`mysql2` 通常可兼容，但如果遇到鉴权问题，可以把用户改成 `mysql_native_password` 或按云厂商方式开启兼容。

### 5.2 Redis

- **推荐版本：Redis 7.x（云厂商托管版）**
- 建议开启：
  - 逐出策略：`volatile-ttl` 或保持默认（取决于你是否存大量缓存）
  - 连接数限制：根据业务机数量与并发设定
- 安全：
  - 使用密码（ACL/requirepass）
  - 仅内网访问（VPC）

## 6. 从本地/Compose 迁移到云数据库：你要怎么操作

下面按“最少踩坑”的顺序给出可执行步骤（云厂商通用）：

### 6.1 准备清单

- 选择云厂商的：
  - **云 MySQL（RDS）**：建议 2核4G 起步 + SSD
  - **云 Redis**：建议 1GB 起步
- 网络：
  - RDS/Redis 放在同一个 VPC/子网（或同地域内网可达）
  - 安全组仅放行业务机 IP/安全组（不要全网 0.0.0.0/0）
- 账号：
  - 创建业务账号（不要用 root）
  - 授权：至少包含建表、建索引、ALTER（因为项目启动阶段会做结构预初始化/迁移）

### 6.2 创建数据库与账号

1) 创建 MySQL 实例（MySQL 8.0）
2) 创建数据库：`chatanki`（默认示例名，可换）
3) 创建用户：例如 `chatanki`
4) 授权：对 `chatanki.*` 授予所需权限（生产建议最小权限，但本项目会做表结构初始化，权限要足够）

### 6.3 导入数据（如果你已有本地数据）

- 若你已有本地 MySQL：用云厂商迁移工具（DTS/数据传输服务）或 `mysqldump` 导入。
- 如果你是全新上线：可以跳过导入，直接让应用初始化建表。

### 6.4 配置后端 `service` 指向云 MySQL + 云 Redis

修改你部署时使用的环境变量文件（例如：`99AI-ANKI/service/.env` 或 docker 部署对应的 `.env.docker`）：

- MySQL：
  - `DB_HOST=<云MySQL内网地址>`
  - `DB_PORT=3306`
  - `DB_USER=<业务用户>`
  - `DB_PASS=<密码>`
  - `DB_DATABASE=<库名>`
- Redis：
  - `REDIS_HOST=<云Redis内网地址>`
  - `REDIS_PORT=6379`
  - `REDIS_PASSWORD=<密码>`（如开启）
  - `REDIS_USER=`（多数云 Redis 不需要用户名）
  - `REDIS_DB=0`

### 6.5 部署方式建议（两条路）

- **路 A：继续用 Docker/Compose 部署应用，但去掉本地 MySQL/Redis 容器**
  - 只保留应用服务容器 `99ai`
  - 环境变量改成云地址

- **路 B：PM2/裸机部署应用**
  - 同样把 `.env` 指向云地址即可

### 6.6 上线前验证（强烈建议）

- 用一台业务机内网连通性测试：
  - MySQL：能连、能建表/建索引
  - Redis：能连、能写 key
- 启动应用观察日志：
  - 看到 “数据库连接成功”
  - 看到 “Redis connection successful”
  - 业务登录/验证码/限流功能正常

## 7. 生产建议（避免后期事故）

- **备份**：
  - MySQL：开启自动备份 + 保留 7~30 天
  - Redis：如云厂商支持 RDB/AOF 或快照备份，建议开启
- **监控告警**：
  - MySQL：CPU、内存、连接数、慢查询数、磁盘使用率
  - Redis：内存使用率、连接数、命令耗时
- **容量规划**：
  - 聊天记录类表增长快：优先关注磁盘与慢查询
  - 2核4G 不够时通常先升配到 4核8G，再考虑读写分离/分库分表

## 8. 建议你补充的关键指标（有了可进一步给精确容量）

如果你愿意补充下面 4 个指标，我可以把“够不够用”从经验判断升级为更精确的容量建议：

1) 日活 DAU / 同时在线峰值
2) 平均每人每天消息条数（写入量）
3) 数据保留策略（聊天记录保留多久）
4) 是否启用知识库/上传（PDF 等）以及日上传量
