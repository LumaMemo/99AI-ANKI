# 99AI-ANKI 安全升级路径 (2025-12-26)

作为网络安全专家，针对本项目（基于开源项目二开）的安全性提升，制定以下升级路径。本方案旨在通过**隐藏服务特征**、**收紧访问控制**、**增强防御机制**三个维度提升系统安全性。

## 1. 基础环境与端口混淆 (Port Obfuscation)

默认端口是攻击者扫描的第一目标。通过修改非标准高位端口，可以规避 90% 的自动化扫描。

| 服务名称           | 当前端口 | 建议端口 | 修改位置                                    |
| :----------------- | :------- | :------- | :------------------------------------------ |
| 后端服务 (Service) | 9520     | 49520    | `service/.env` -> `PORT`                |
| 管理端前端 (Admin) | 9000     | 49000    | `admin/vite.config.ts` -> `server.port` |
| 用户端前端 (Chat)  | 9002     | 49002    | `chat/vite.config.ts` -> `server.port`  |

**注意**：修改端口后，需同步更新前端 `.env` 中的 `VITE_APP_API_BASEURL` 或 `VITE_GLOB_API_URL`。

## 2. 后台路径隐蔽化 (Admin Path Obfuscation)

`/admin` 是极易被爆破的路径。将其修改为复杂的随机字符串。

- **当前路径**: `/admin`
- **建议路径**: `/ghjy-lumamemo-admin`
- **修改位置**:
  - `service/.env` -> `ADMIN_SERVE_ROOT`
  - 部署脚本或 Nginx 配置（如有）

## 3. 访问控制强化 (Access Control)

### 3.1 CORS 策略收紧

目前后端 `main.ts` 中 `origin: '*'` 允许任何域名跨域访问，存在安全风险。

- **修改建议**: 在生产环境下，仅允许前端部署的域名访问。lumamemo.com
- **修改位置**: `service/src/main.ts` 中的 `app.enableCors()` 配置。

## 4. 防御机制增强 (Defense Mechanism)

### 4.1 引入 Helmet

Helmet 可以通过设置各种 HTTP 标头来帮助保护应用免受一些众所周知的 Web 漏洞的影响。

- **操作**: `npm install helmet`
- **修改位置**: `service/src/main.ts` 中添加 `app.use(helmet())`。

### 4.2 速率限制 (Rate Limiting)

检查并强化 `RateLimitModule`。

- **重点**: 针对登录接口、验证码接口设置严格的频率限制，防止暴力破解。

## 5. 敏感信息审计与文件安全

### 5.1 文件上传安全

目前 `UploadService` 使用了黑名单机制 (`exe`, `sh` 等)，但建议升级为**白名单机制**。

- **修改建议**: 仅允许 `jpg`, `png`, `pdf`, `docx` 等必要格式。
- **文件大小限制**: 确保在 NestJS 层级限制上传文件大小，防止磁盘耗尽攻击。

### 5.2 敏感信息审计，按照生产环境来部署，测试的时候不变

- **Swagger 文档**: 确保生产环境 (`ISDEV=false`) 下完全关闭 `/api-docs`。
- **错误堆栈**: 确保生产环境下不向前端返回详细的错误堆栈信息。
- **日志脱敏**: 检查日志输出，确保不会记录用户的密码、Token 等敏感信息。

## 6. 实施路线图 (Roadmap)

1. **第一阶段 (立即执行)**: 修改端口和后台路径，更新所有 `.env` 配置文件，适配域名 `lumamemo.com`。 **(已完成 - 2025-12-26)**
2. **第二阶段 (代码加固)**: 引入 Helmet，收紧 CORS 策略，配置生产环境 JWT 密钥。 **(已完成 - 2025-12-26)**
3. **第三阶段 (运维加固)**: 修改数据库密码，配置防火墙规则，关闭不必要的端口。

## 7. 详细实施步骤

### 7.1 端口与路径修改 (第一阶段)

1. **后端服务端口**:
   - 修改 [service/.env](service/.env) 中的 `PORT=49520`。
   - 修改 [service/.env](service/.env) 中的 `ADMIN_SERVE_ROOT=/ghjy-lumamemo-admin`。
2. **管理端配置**:
   - 修改 [admin/vite.config.ts](admin/vite.config.ts) 中的 `server.port: 49000`。
   - 修改 [admin/.env.production](admin/.env.production) 中的 `VITE_APP_API_BASEURL=https://lumamemo.com/api`。
3. **用户端配置**:
   - 修改 [chat/vite.config.ts](chat/vite.config.ts) 中的 `server.port: 49002`。
   - 修改 [chat/.env.production](chat/.env.production) 中的 `VITE_GLOB_API_URL=https://lumamemo.com/api`。

### 7.2 代码安全加固 (第二阶段)

1. **引入 Helmet**:
   - 在 `service` 目录下运行: `pnpm add helmet`。
   - 在 [service/src/main.ts](service/src/main.ts) 中引入并使用:
     ```typescript
     import helmet from 'helmet';
     // ... 在 bootstrap 函数中
     app.use(helmet({
       contentSecurityPolicy: false, // 如果有内联脚本需求可关闭或精细配置
     }));
     ```
2. **收紧 CORS**:
   - 修改 [service/src/main.ts](service/src/main.ts) 中的 `enableCors` 配置:
     ```typescript
     const isDev = process.env.ISDEV === 'true';
     app.enableCors({
       origin: isDev ? '*' : ['https://lumamemo.com', 'https://www.lumamemo.com'],
       methods: 'GET,HEAD,PUT,PATCH,POST,DELETE',
       credentials: true,
     });
     ```

### 7.3 文件上传白名单化 (第三阶段)，暂时不修改

1. **修改上传逻辑**:
   - 修改 [service/src/modules/upload/upload.service.ts](service/src/modules/upload/upload.service.ts):
     - 将 `blacklist` 替换为 `whitelist = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'docx', 'txt']`。
     - 修改校验逻辑，仅允许白名单内的后缀。

---

**安全提示**: 在执行任何修改前，请务必备份 `.env` 文件和数据库。
