# 蓝兔支付（ltzf）支付通知地址/回调地址填写与自测指南（99AI-ANKI）

本文用于说明在本项目中「支付通知地址（notify_url）」与「支付回调地址（return_url）」应该如何填写、分别由谁触发、以及如何做最小化自测排查。

> 适用范围：本仓库的 `service`（NestJS 后端）+ `admin`（管理后台）中的「蓝兔支付设置」。

---

## 1. 两个地址分别是什么（非常重要）

### 1.1 支付通知地址（notify_url）

- **触发方**：蓝兔支付平台服务器
- **触发时机**：支付成功/状态变更后，平台向你后端发起请求
- **用途**：后端据此**验签并更新订单状态（真正决定是否入账）**
- **本项目后端实际接口**：

```
POST https://你的后端域名/api/pay/notify
```

> 在本项目中，蓝兔支付的入账逻辑位于 `PayService.notifyLtzf()`，由 `PayController` 的 `/pay/notify` 路由接收。


### 1.2 支付回调地址（return_url）

- **触发方**：用户浏览器/微信内置浏览器（由支付页面跳转）
- **触发时机**：用户完成支付后，页面跳转回你的网站
- **用途**：**给用户看的页面**（比如“支付成功/充值成功”），不负责入账

典型填写：

```
https://你的前端域名/
```

或你前端项目存在明确的落地页：

```
https://你的前端域名/#/pay/success
```

> 重点：**return_url 不影响订单是否成功**。订单是否成功以 notify_url 的异步通知为准。

---

## 2. 这两个地址是蓝兔后台配，还是本系统里配？

在本项目里，这两个地址是在**管理后台（admin）里配置**的：

- `支付通知地址` → 保存到全局配置 `payLtzfNotifyUrl`
- `支付回调地址` → 保存到全局配置 `payLtzfReturnUrl`

当用户发起支付时，后端请求蓝兔接口 `https://api.ltzf.cn/api/wxpay/jsapi_convenient`，会把你配置的：

- `notify_url = payLtzfNotifyUrl`
- `return_url = payLtzfReturnUrl`

作为参数提交给蓝兔。

**通常不需要你再去蓝兔后台填写 notify/return 地址**（除非蓝兔要求配置“回调域名白名单/备案域名”等安全项，那就按蓝兔平台要求把你的域名加入即可）。

---

## 3. 推荐填写模板（可直接复制改域名）

### 3.1 支付通知地址（notify_url）

- 推荐：

```
https://api.example.com/api/pay/notify
```

说明：
- 必须是**公网可访问**的后端域名
- 建议使用 HTTPS
- **不要在末尾加点号 `.`**
- 注意 `https://` 是两个斜杠

### 3.2 支付回调地址（return_url）

- 最保守写法（一定能回到站点）：

```
https://www.example.com/
```

- 如果你有明确成功页：

```
https://www.example.com/#/pay
```

> 如果前后端同域（例如都在 `https://example.com`），notify 仍然建议用后端真实可达的地址（通常是同域反代到后端的 `/api`）。

---

## 4. 为什么 notify_url 需要带 `/api`？

本项目后端在启动时设置了全局前缀：

- 大部分接口：`/api/...`

并且：
- **GET 请求被排除在全局前缀之外**（即 GET 不强制 `/api`）

而蓝兔支付通知在本项目是：

- `POST /pay/notify`

因此它的完整外部路径就是：

```
POST /api/pay/notify
```

---

## 5. 最小自测方法（不依赖蓝兔后台）

> 目标：确认你的部署环境上，`/api/pay/notify` 这条路由可达（至少能进到应用），以及 Nginx/反代没有挡住 POST。

### 5.1 连通性测试（只测“能不能访问到服务”）

用 curl（Windows 也可用 PowerShell 的 `curl.exe`）对 notify 地址发一个最简 POST：

```
curl -X POST https://api.example.com/api/pay/notify -H "Content-Type: application/json" -d "{}"
```

预期：
- 你可能会收到 `FAIL` / `failed` / 4xx（因为没有蓝兔真实参数，验签必失败）
- 但只要**不是 404/502/504**，通常表示路由和网关打通了


### 5.2 观察服务端日志

当 notify 被命中时，后端控制器会输出类似：

- `ltzf ->body: ...`

如果完全没有日志：
- 多数是域名没解析到你的服务器
- 或反代没把 `/api/pay/notify` 转到 NestJS
- 或防火墙/WAF 拦截了第三方 POST

---

## 6. 常见坑位排查

1) **地址写成 `https:/你的域名/...`**（少一个 `/`）
- 正确：`https://你的域名/...`

2) **地址末尾多了一个点号 `.`**
- 正确：不要有结尾 `.`

3) **notify_url 写成了前端域名但没有反代到后端**
- 结果：蓝兔请求到前端静态站点，后端收不到通知，订单永远不入账

4) **服务端只开了 HTTP，但你填了 HTTPS（或证书无效）**
- 结果：平台回调失败

5) **回调成功但仍显示未到账**
- 常见原因：notify 没收到（return_url 只是页面跳转）

---

## 7. 最终填写清单（你在 admin 页面要填什么）

在「蓝兔支付设置」里：

- 启用当前支付：开启
- 商户号：填蓝兔给你的 `mch_id`
- 商户密钥：填蓝兔给你的 `key`
- 支付通知地址：`https://你的后端域名/api/pay/notify`
- 支付回调地址：`https://你的前端域名/`（或你的支付成功页）

---

## 8. 需要我帮你对照部署结构精确写值吗？

你只要补充两项信息（任意一项也行）：

- 你的“前端访问域名”是什么（用户打开站点的域名）
- 你的“后端 API 域名”是什么（或是否由同域 `/api` 反代）

我就能给你一组**可直接粘贴**且与实际部署完全匹配的 notify/return 地址。
